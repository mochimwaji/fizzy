<%# Mobile board view with expandable categories %>
<%# Each category can be clicked to expand/collapse, showing cards inline %>
<%# Cards can be dragged from one category row to another %>
<%# Design matches the desktop column styling %>

<section class="mobile-board" 
         data-controller="mobile-board drag-and-drop"
         data-drag-and-drop-dragged-item-class="drag-and-drop__dragged-item"
         data-drag-and-drop-hover-container-class="drag-and-drop__hover-container"
         data-mobile-board-board-id-value="<%= board.id %>"
         data-mobile-board-account-id-value="<%= board.account.external_account_id %>">
  
  <div class="mobile-board__add-card">
    <%= render "columns/show/add_card_button", board: board %>
  </div>

  <%# Not Now category %>
  <div class="mobile-board__category" 
       id="mobile-category-not-now"
       data-mobile-board-target="category"
       data-drag-and-drop-target="container"
       data-drag-and-drop-url="<%= card_not_now_path('__id__') %>"
       data-category-type="not_now"
       data-category-id="not_now"
       data-category-name="Not Now"
       style="--card-color: var(--color-card-1);">
    <div class="mobile-board__category-header" 
         data-action="click->mobile-board#toggle"
         data-mobile-board-target="header"
         aria-expanded="false"
         aria-controls="mobile-category-not-now-cards">
      <div class="mobile-board__category-expander">
        <span class="mobile-board__category-count" data-drag-and-drop-counter><%= board.cards.postponed.count %></span>
        <span class="mobile-board__category-title">Not Now</span>
        <%= icon_tag "collapse", class: "mobile-board__category-collapse-icon" %>
      </div>
    </div>
    <div class="mobile-board__category-cards" 
         id="mobile-category-not-now-cards"
         data-mobile-board-target="cardList">
      <% board.cards.postponed.latest.limit(50).each do |card| %>
        <%= render "cards/display/preview", card: card, draggable: true %>
      <% end %>
      <% if board.cards.postponed.count == 0 %>
        <div class="mobile-board__empty">No cards</div>
      <% end %>
    </div>
  </div>

  <%# Maybe/Stream category %>
  <div class="mobile-board__category" 
       id="mobile-category-stream"
       data-mobile-board-target="category"
       data-drag-and-drop-target="container"
       data-drag-and-drop-url="<%= columns_card_drops_stream_path('__id__') %>"
       data-category-type="stream"
       data-category-id="stream"
       data-category-name="Maybe?"
       style="--card-color: var(--color-card-2);">
    <div class="mobile-board__category-header" 
         data-action="click->mobile-board#toggle"
         data-mobile-board-target="header"
         aria-expanded="false"
         aria-controls="mobile-category-stream-cards">
      <div class="mobile-board__category-expander">
        <span class="mobile-board__category-count" data-drag-and-drop-counter><%= board.cards.awaiting_triage.count %></span>
        <span class="mobile-board__category-title">Maybe?</span>
        <%= icon_tag "collapse", class: "mobile-board__category-collapse-icon" %>
      </div>
    </div>
    <div class="mobile-board__category-cards" 
         id="mobile-category-stream-cards"
         data-mobile-board-target="cardList">
      <% board.cards.awaiting_triage.latest.limit(50).each do |card| %>
        <%= render "cards/display/preview", card: card, draggable: true %>
      <% end %>
      <% if board.cards.awaiting_triage.count == 0 %>
        <div class="mobile-board__empty">No cards</div>
      <% end %>
    </div>
  </div>

  <%# Column categories %>
  <% board.columns.sorted.each do |column| %>
    <div class="mobile-board__category mobile-board__category--editable" 
         id="mobile-category-column-<%= column.id %>"
         data-mobile-board-target="category"
         data-drag-and-drop-target="container"
         data-drag-and-drop-url="<%= columns_card_drops_column_path('__id__', column_id: column.id) %>"
         data-category-type="column"
         data-category-id="<%= column.id %>"
         data-category-name="<%= column.name %>"
         style="--card-color: <%= column.color %>;">
      <div class="mobile-board__category-header" 
           data-action="click->mobile-board#toggle"
           data-mobile-board-target="header"
           aria-expanded="false"
           aria-controls="mobile-category-column-<%= column.id %>-cards">
        <div class="mobile-board__category-expander">
          <span class="mobile-board__category-count" data-drag-and-drop-counter><%= column.cards.active.count %></span>
          <span class="mobile-board__category-title"><%= column.name %></span>
          <%= icon_tag "collapse", class: "mobile-board__category-collapse-icon" %>
        </div>
      </div>
      
      <%# Edit form for column (shown when expanded) %>
      <div class="mobile-board__category-edit" data-mobile-board-target="editForm">
        <%= form_with model: [board, column], 
                      data: { 
                        controller: "form", 
                        action: "turbo:submit-end->mobile-board#handleEditSubmit" 
                      },
                      class: "mobile-board__edit-form" do |form| %>
          <div class="mobile-board__edit-name-row">
            <%= form.text_field :name, 
                                class: "input mobile-board__edit-input", 
                                placeholder: "Column name", 
                                value: column.name,
                                required: true, 
                                autocomplete: "off" %>
          </div>
          <div class="mobile-board__edit-colors">
            <% Color::COLORS.each do |color| %>
              <label class="mobile-board__color-option" style="--option-color: <%= color.value %>" title="<%= color.name %>">
                <%= form.radio_button :color, color.value, checked: (column.color == color) %>
                <span class="mobile-board__color-swatch"></span>
              </label>
            <% end %>
          </div>
          <div class="mobile-board__edit-actions">
            <%= form.submit "Save", class: "btn btn--small" %>
          </div>
        <% end %>
      </div>
      
      <div class="mobile-board__category-cards" 
           id="mobile-category-column-<%= column.id %>-cards"
           data-mobile-board-target="cardList">
        <% column.cards.active.latest.limit(50).each do |card| %>
          <%= render "cards/display/preview", card: card, draggable: true %>
        <% end %>
        <% if column.cards.active.count == 0 %>
          <div class="mobile-board__empty">No cards</div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Done category %>
  <div class="mobile-board__category" 
       id="mobile-category-closed"
       data-mobile-board-target="category"
       data-drag-and-drop-target="container"
       data-drag-and-drop-url="<%= card_closure_path('__id__') %>"
       data-category-type="closed"
       data-category-id="closed"
       data-category-name="Done"
       style="--card-color: var(--color-card-complete);">
    <div class="mobile-board__category-header" 
         data-action="click->mobile-board#toggle"
         data-mobile-board-target="header"
         aria-expanded="false"
         aria-controls="mobile-category-closed-cards">
      <div class="mobile-board__category-expander">
        <span class="mobile-board__category-count" data-drag-and-drop-counter><%= board.cards.closed.count %></span>
        <span class="mobile-board__category-title">Done</span>
        <%= icon_tag "collapse", class: "mobile-board__category-collapse-icon" %>
      </div>
    </div>
    <div class="mobile-board__category-cards" 
         id="mobile-category-closed-cards"
         data-mobile-board-target="cardList">
      <% board.cards.closed.latest.limit(50).each do |card| %>
        <%= render "cards/display/preview", card: card, draggable: true %>
      <% end %>
      <% if board.cards.closed.count == 0 %>
        <div class="mobile-board__empty">No cards</div>
      <% end %>
    </div>
  </div>

  <%# Add New Column button %>
  <div class="mobile-board__add-column" data-controller="dialog" data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside">
    <button class="mobile-board__add-column-button" data-action="click->dialog#open:stop">
      <%= icon_tag "add" %>
      <span class="for-screen-reader">Add a column</span>
    </button>
    <dialog class="popup panel flex-column gap-half fill-white shadow txt-small" data-dialog-target="dialog">
      <%= render "boards/show/menu/column_form", board: board, column: Column.new, label: "Add column" %>
    </dialog>
  </div>
</section>
