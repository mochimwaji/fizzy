<% day_classes = class_names(
  "calendar__day",
  "calendar__day--other-month": !current_month,
  "calendar__day--today": date == Date.current,
  "calendar__day--weekend": date.saturday? || date.sunday?,
  "calendar__day--has-cards": cards.any?
) %>

<%= tag.div class: day_classes,
    id: "calendar-day-#{date.iso8601}",
    data: { 
      date: date.iso8601,
      calendar_drag_drop_target: "day",
      action: "dragover->calendar-drag-drop#dragOver dragenter->calendar-drag-drop#dragEnter dragleave->calendar-drag-drop#dragLeave drop->calendar-drag-drop#drop"
    } do %>
  <div class="calendar__date-wrapper">
    <span class="calendar__date"><%= date.day %></span>
    <% if cards.any? %>
      <span class="calendar__card-count"><%= cards.size %></span>
    <% end %>
  </div>

  <div class="calendar__cards" data-controller="calendar-expand">
    <% if cards.any? %>
      <% max_visible = 1 %>
      <% cards.first(max_visible).each do |card| %>
        <%= link_to calendar_card_path(card, date: current_date), 
            class: class_names("calendar__card", "calendar__card--overdue": card.overdue?, "calendar__card--closed": card.closed? || card.postponed?), 
            title: "#{card.board.name}: #{card.title}",
            style: "--card-color: #{card.color}",
            draggable: true,
            data: { 
              turbo_frame: "calendar_card_modal",
              card_id: card.number,
              calendar_drag_drop_target: "card",
              action: "dragstart->calendar-drag-drop#dragStart dragend->calendar-drag-drop#dragEnd"
            } do %>
          <span class="calendar__card-title"><%= card.title %></span>
        <% end %>
      <% end %>

      <% if cards.size > max_visible %>
        <% cards.drop(max_visible).each do |card| %>
          <%= link_to calendar_card_path(card, date: current_date), 
              class: class_names("calendar__card", "calendar__card--hidden", "calendar__card--overdue": card.overdue?, "calendar__card--closed": card.closed? || card.postponed?), 
              title: "#{card.board.name}: #{card.title}",
              style: "--card-color: #{card.color}",
              draggable: true,
              data: { 
                turbo_frame: "calendar_card_modal",
                card_id: card.number,
                calendar_drag_drop_target: "card",
                calendar_expand_target: "hidden",
                action: "dragstart->calendar-drag-drop#dragStart dragend->calendar-drag-drop#dragEnd"
              } do %>
            <span class="calendar__card-title"><%= card.title %></span>
          <% end %>
        <% end %>

        <button class="calendar__more" data-action="calendar-expand#toggle" data-calendar-expand-target="toggle">
          <span class="calendar__more-text">+<%= cards.size - max_visible %> more</span>
        </button>
      <% end %>
    <% end %>

    <div class="calendar__drop-zone">
      <span class="calendar__drop-icon"><%= icon_tag "plus" %></span>
    </div>
  </div>
<% end %>
